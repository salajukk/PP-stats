<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PP Stats</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0f14;--surface:#161920;--surface2:#1e2230;--accent:#f0a500;--win:#3ecf8e;--loss:#e05a2b;--text:#e8eaf0;--muted:#7a8090;--border:#2a2f3e}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  header{background:linear-gradient(135deg,#0d0f14,#1a1f2e);border-bottom:1px solid var(--border);padding:28px 40px 20px;display:flex;align-items:flex-end;gap:24px;flex-wrap:wrap}
  .htitle{font-family:'Bebas Neue',sans-serif;font-size:3rem;letter-spacing:3px;color:var(--accent);line-height:1}
  .hsub{font-size:.85rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
  .badge{margin-left:auto;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:10px 20px;text-align:center}
  .badge-num{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--win);letter-spacing:2px}
  .badge-lbl{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  #loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:16px}
  .spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-text{color:var(--muted);font-size:.9rem;letter-spacing:1px}
  #error-msg{display:none;margin:40px;padding:24px;background:rgba(224,90,43,.1);border:1px solid var(--loss);border-radius:12px;color:var(--loss);line-height:1.8;font-size:.9rem}
  #error-msg a{color:var(--accent)}
  #app{display:none}
  nav{display:flex;gap:4px;padding:16px 40px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;align-items:center}
  .tab{padding:8px 20px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:500;cursor:pointer;letter-spacing:.5px;white-space:nowrap;transition:all .2s}
  .tab:hover{color:var(--text);background:var(--surface2)}
  .tab.active{background:var(--accent);color:#0d0f14;font-weight:600}
  .season-select{margin-left:auto;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;padding:6px 14px;border-radius:8px;cursor:pointer;outline:none}
  .section{display:none;padding:32px 40px}
  .section.active{display:block}
  h2{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:2px;color:var(--accent);margin-bottom:6px}
  .sdesc{color:var(--muted);font-size:.85rem;margin-bottom:24px}
  .chip-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
  .chip-label{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
  .chip{padding:6px 16px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);font-size:.8rem;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
  .chip:hover{border-color:var(--accent);color:var(--text)}
  .chip.on{color:#0d0f14;font-weight:600;border-color:transparent}
  .radar-wrap{max-width:520px;margin:0 auto}
  .cbox{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px}
  .team-wrap{max-width:820px}
  .sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(215px,1fr));gap:16px}
  .sc{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;transition:border-color .2s}
  .sc:hover{border-color:var(--accent)}
  .sc-name{font-weight:600;font-size:.95rem;margin-bottom:12px}
  .bl{display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:4px}
  .bt{background:var(--surface2);border-radius:4px;height:8px;margin-bottom:10px;overflow:hidden}
  .bf{height:100%;border-radius:4px;transition:width .6s}
  .bfg{background:var(--accent)}.b3p{background:#5b8dee}
  .big{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--accent);letter-spacing:1px}
  .biglbl{font-size:.7rem;color:var(--muted);text-transform:uppercase}
  .twrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:.85rem}
  th{background:var(--surface2);color:var(--muted);font-weight:500;text-transform:uppercase;font-size:.7rem;letter-spacing:1px;padding:10px 12px;text-align:right;cursor:pointer;user-select:none;white-space:nowrap;position:sticky;top:0;z-index:2}
  th:first-child{text-align:left;position:sticky;left:0;top:0;z-index:3;background:var(--surface2)}
  th:hover{color:var(--accent)}
  th.sa::after{content:' ‚ñ≤'}th.sd::after{content:' ‚ñº'}
  td{padding:10px 12px;text-align:right;border-bottom:1px solid var(--border)}
  td:first-child{text-align:left;font-weight:500;position:sticky;left:0;z-index:1;background:var(--bg)}
  tr:hover td{background:var(--surface)}
  tr:hover td:first-child{background:var(--surface)}
  tr.total-row td{background:var(--surface2);font-weight:600;color:var(--text);border-top:2px solid var(--border);border-bottom:2px solid var(--border)}
  tr.total-row td:first-child{color:var(--accent);background:var(--surface2)}
  .hl{color:var(--accent);font-weight:600}
  .upd{font-size:.75rem;color:var(--muted);margin-top:12px;text-align:right}
  @media(max-width:600px){
    header{padding:20px}.htitle{font-size:2rem}
    nav{padding:12px 16px}.section{padding:20px 16px}
    .mobile-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:8px}
    .mobile-scroll .cbox{min-width:600px}
    .mobile-hint{font-size:.72rem;color:var(--muted);margin-bottom:8px;display:block}
  }
  @media(min-width:601px){.mobile-hint{display:none}}
</style>
</head>
<body>
<header>
  <div><div class="hsub">Tilastot</div><div class="htitle">PP Stats</div></div>
  <div class="badge"><div class="badge-num" id="record">‚Äì</div><div class="badge-lbl">Sarja</div></div>
</header>
<div id="loading"><div class="spinner"></div><div class="loading-text">Ladataan Google Sheetsist√§‚Ä¶</div></div>
<div id="error-msg">
  <strong>‚ö†Ô∏è Dataa ei voitu ladata.</strong><br><br>
  Varmista ett√§ Google Sheet on julkinen (Jaa ‚Üí Kuka tahansa linkill√§ ‚Üí Katselija)<br><br>
  <a href="https://docs.google.com/spreadsheets/d/1FKKi68DYKU4ABToYjN50HLhT8hOc06cIKNWNHWa8RYA" target="_blank">Avaa sheet ‚Üí</a>
</div>
<div id="app">
  <nav>
    <button class="tab active" onclick="showTab('radar',this)">üï∏ Pelaajaprofiilit</button>
    <button class="tab" onclick="showTab('timeline',this)">üìà Pistekehitys</button>
    <button class="tab" onclick="showTab('team',this)">üèÄ Joukkue</button>
    <button class="tab" onclick="showTab('shooting',this)">üéØ Heittotehokkuus</button>
    <button class="tab" onclick="showTab('tbl',this)">üìä Tilastot</button>
    <select class="season-select" id="seasonSel" onchange="changeSeason()"></select>
  </nav>
  <section id="radar" class="section active">
    <h2>Pelaajaprofiilit</h2><p class="sdesc">Vertaile kahta pelaajaa kuudella osa-alueella.</p>
    <div class="chip-label">Pelaaja 1</div><div class="chip-row" id="c1"></div>
    <div class="chip-label" style="margin-top:8px">Pelaaja 2</div><div class="chip-row" id="c2"></div>
    <div class="radar-wrap" style="margin-top:20px"><div class="cbox"><canvas id="radarC"></canvas></div></div>
  </section>
  <section id="timeline" class="section">
    <h2>Pistekehitys ottelusta toiseen</h2><p class="sdesc">Valitse pelaajat.</p>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
      <div class="chip-row" id="tlChips" style="margin-bottom:0;flex:1"></div>
      <div style="display:flex;background:var(--surface2);border:1px solid var(--border);border-radius:8px;overflow:hidden;flex-shrink:0">
        <button id="btnPeli" onclick="setTlMode('peli')" style="padding:7px 16px;border:none;background:var(--accent);color:#0d0f14;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer">Per peli</button>
        <button id="btnKumu" onclick="setTlMode('kumu')" style="padding:7px 16px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer">Kumulatiivinen</button>
      </div>
    </div>
    <span class="mobile-hint">üëÜ Voit vieritt√§√§ kaaviota sivusuunnassa</span>
    <div class="mobile-scroll"><div class="cbox"><canvas id="tlC" height="180"></canvas></div></div>
  </section>
  <section id="team" class="section">
    <h2>Joukkueen tulokset</h2><p class="sdesc">Vihre√§ = voitto, oranssi = tappio.</p>
    <span class="mobile-hint">üëÜ Voit vieritt√§√§ kaaviota sivusuunnassa</span>
    <div class="mobile-scroll"><div class="cbox team-wrap"><canvas id="teamC" height="180"></canvas></div></div>
    <p class="upd" id="upd"></p>
  </section>
  <section id="shooting" class="section">
    <h2>Heittotehokkuus</h2><p class="sdesc">FG% ja 3PT% per pelaaja.</p>
    <div class="sg" id="sg"></div>
  </section>
  <section id="tbl" class="section">
    <h2>Tilastotaulukko</h2>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap">
      <p class="sdesc" style="margin-bottom:0">Klikkaa rivi√§ suodattaaksesi toisen taulukon.</p>
      <div style="display:flex;background:var(--surface2);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-left:auto;flex-shrink:0">
        <button id="btnYht" onclick="setTblMode('yht')" style="padding:7px 16px;border:none;background:var(--accent);color:#0d0f14;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer">Yhteens√§</button>
        <button id="btnPPeli" onclick="setTblMode('ppeli')" style="padding:7px 16px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer">Per peli</button>
      </div>
    </div>

    <h3 style="font-size:.8rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px" id="p1label">Pelaajat <span id="filterBadge" style="display:none;background:var(--accent);color:#0d0f14;border-radius:4px;padding:2px 8px;font-size:.7rem;margin-left:8px;cursor:pointer" onclick="clearFilter()">‚úï Tyhjenn√§ suodatin</span></h3>
    <div class="twrap" style="margin-bottom:32px">
      <table id="playerTable"><thead><tr>
        <th onclick="srtP('label')">Player</th>
        <th onclick="srtP('gp')" title="Games Played">GP</th>
        <th onclick="srtP('pts')" title="Points">PTS</th>
        <th onclick="srtP('min')" title="Minutes">MIN</th>
        <th onclick="srtP('fgm')" title="Field Goals Made">FGM</th>
        <th onclick="srtP('fga')" title="Field Goals Attempted">FGA</th>
        <th onclick="srtP('fgpct')" title="Field Goal Percentage">FG%</th>
        <th onclick="srtP('t3m')" title="3-Pointers Made">3PM</th>
        <th onclick="srtP('t3a')" title="3-Pointers Attempted">3PA</th>
        <th onclick="srtP('t3pct')" title="3-Point Percentage">3P%</th>
        <th onclick="srtP('ftm')" title="Free Throws Made">FTM</th>
        <th onclick="srtP('fta')" title="Free Throws Attempted">FTA</th>
        <th onclick="srtP('ftpct')" title="Free Throw Percentage">FT%</th>
        <th onclick="srtP('orb')" title="Offensive Rebounds">ORB</th>
        <th onclick="srtP('drb')" title="Defensive Rebounds">DRB</th>
        <th onclick="srtP('rb')" title="Total Rebounds">REB</th>
        <th onclick="srtP('ast')" title="Assists">AST</th>
        <th onclick="srtP('stl')" title="Steals">STL</th>
        <th onclick="srtP('blk')" title="Blocks">BLK</th>
        <th onclick="srtP('to')" title="Turnovers">TOV</th>
        <th onclick="srtP('pf')" title="Personal Fouls">PF</th>
      </tr></thead><tbody id="tbP"></tbody></table>
    </div>

    <h3 style="font-size:.8rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px" id="p2label">Vastustajat</h3>
    <div class="twrap">
      <table id="oppTable"><thead><tr>
        <th onclick="srtO('label')" title="Opponent">Vastustaja</th>
        <th onclick="srtO('oppPts')" title="Opponent Score">OPP</th>
        <th onclick="srtO('plr')" title="Players in game">PLR</th>
        <th onclick="srtO('pts')" title="Points">PTS</th>
        <th onclick="srtO('min')" title="Minutes">MIN</th>
        <th onclick="srtO('fgm')" title="Field Goals Made">FGM</th>
        <th onclick="srtO('fga')" title="Field Goals Attempted">FGA</th>
        <th onclick="srtO('fgpct')" title="Field Goal Percentage">FG%</th>
        <th onclick="srtO('t3m')" title="3-Pointers Made">3PM</th>
        <th onclick="srtO('t3a')" title="3-Pointers Attempted">3PA</th>
        <th onclick="srtO('t3pct')" title="3-Point Percentage">3P%</th>
        <th onclick="srtO('ftm')" title="Free Throws Made">FTM</th>
        <th onclick="srtO('fta')" title="Free Throws Attempted">FTA</th>
        <th onclick="srtO('ftpct')" title="Free Throw Percentage">FT%</th>
        <th onclick="srtO('orb')" title="Offensive Rebounds">ORB</th>
        <th onclick="srtO('drb')" title="Defensive Rebounds">DRB</th>
        <th onclick="srtO('rb')" title="Total Rebounds">REB</th>
        <th onclick="srtO('ast')" title="Assists">AST</th>
        <th onclick="srtO('stl')" title="Steals">STL</th>
        <th onclick="srtO('blk')" title="Blocks">BLK</th>
        <th onclick="srtO('to')" title="Turnovers">TOV</th>
        <th onclick="srtO('pf')" title="Personal Fouls">PF</th>
      </tr></thead><tbody id="tbO"></tbody></table>
    </div>
  </section>
</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyDbxGfzz3nuDHoqRB6rTy9tYj1vDWbPW159O2OQzsmEfRFCnN92h_bp6qfAMwFo4vMA/exec';
const PAL = ['#f0a500','#5b8dee','#3ecf8e','#e05a2b','#c084fc','#f472b6','#34d399','#fb923c','#60a5fa','#a78bfa','#fbbf24','#4ade80'];

const COL = {
  nimi:'Nimi', ottelu:'Ottelunumero', vastustaja:'Vastustaja',
  pisteet:'Pisteet', kotiv:'Koti/Vieras', tulos:'Lopputulos',
  kausi:'Kausi', sarja:'Sarja/Harjoitus',
  omaPts:'Omat pisteet', vastPts:'Vastustajan pisteet',
  fgm:'FGM', fga:'FGA', t3m:'3PTM', t3a:'3PTA',
  ftm:'FTM', fta:'FTA', orb:'ORB', drb:'DRB', rb:'RB',
  ast:'AST', stl:'STL', blk:'BLK', to:'TO', pf:'PF'
};

let allRows=[], seasons=[], curSeason='';
let pStats={}, gData={}, tGames=[], players=[];
let r1='', r2='', tlSel=new Set();
let rChart, tlChart, tmChart;
let sKey='EFF', sDesc=true;
let tlMode='peli'; // 'peli' tai 'kumu'

function setTlMode(mode){
  tlMode=mode;
  document.getElementById('btnPeli').style.background=mode==='peli'?'var(--accent)':'transparent';
  document.getElementById('btnPeli').style.color=mode==='peli'?'#0d0f14':'var(--muted)';
  document.getElementById('btnPeli').style.fontWeight=mode==='peli'?'600':'500';
  document.getElementById('btnKumu').style.background=mode==='kumu'?'var(--accent)':'transparent';
  document.getElementById('btnKumu').style.color=mode==='kumu'?'#0d0f14':'var(--muted)';
  document.getElementById('btnKumu').style.fontWeight=mode==='kumu'?'600':'500';
  buildTimeline();
}

// ‚îÄ‚îÄ Fetch Apps Scriptist√§ (ei CORS-ongelmia) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const res = await fetch(APPS_SCRIPT_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    allRows = await res.json();
    initApp();
  } catch(e) {
    showError('Virhe: ' + e.message);
  }
}

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  const el = document.getElementById('error-msg');
  el.style.display = 'block';
  el.innerHTML += '<br><small style="opacity:.7">Tekninen tieto: ' + msg + '</small>';
}

function n(v){ return (v==null||isNaN(v)) ? 0 : +v; }

function processSeason(s){
  const rows = allRows.filter(r => r[COL.kausi]===s && r[COL.sarja]==='Sarja');
  const gm = {};
  rows.forEach(r => { const k=r[COL.ottelu]; if(!gm[k]) gm[k]=r; });
  tGames = Object.values(gm).sort((a,b) => a[COL.ottelu]-b[COL.ottelu]);

  const pm = {};
  rows.forEach(r => {
    const nm = r[COL.nimi]; if(!nm) return;
    if(!pm[nm]) pm[nm]={gs:new Set(),pts:0,fgm:0,fga:0,t3m:0,t3a:0,ftm:0,fta:0,rb:0,orb:0,ast:0,stl:0,blk:0,to:0,pf:0,hasAdv:false};
    const p = pm[nm];
    p.gs.add(r[COL.ottelu]);
    p.pts += n(r[COL.pisteet]);
    if(r[COL.fgm] != null) p.hasAdv = true;
    p.fgm+=n(r[COL.fgm]); p.fga+=n(r[COL.fga]);
    p.t3m+=n(r[COL.t3m]); p.t3a+=n(r[COL.t3a]);
    p.ftm+=n(r[COL.ftm]); p.fta+=n(r[COL.fta]);
    p.rb+=n(r[COL.rb]);   p.orb+=n(r[COL.orb]);
    p.ast+=n(r[COL.ast]); p.stl+=n(r[COL.stl]);
    p.blk+=n(r[COL.blk]); p.to+=n(r[COL.to]); p.pf+=n(r[COL.pf]);
  });

  pStats = {};
  Object.entries(pm).forEach(([nm,p]) => {
    const g = p.gs.size;
    const eff = p.pts+p.rb+p.ast+p.stl+p.blk-p.to-(p.fga-p.fgm)-(p.fta-p.ftm);
    pStats[nm] = {
      Pelit:g, PPG:+(p.pts/g).toFixed(1), RPG:+(p.rb/g).toFixed(1),
      APG:+(p.ast/g).toFixed(1), SPG:+(p.stl/g).toFixed(1), BPG:+(p.blk/g).toFixed(1),
      TOPG:+(p.to/g).toFixed(1), FGp:p.fga>0?+(p.fgm/p.fga*100).toFixed(1):0,
      P3p:p.t3a>0?+(p.t3m/p.t3a*100).toFixed(1):0, P3a:+(p.t3a/g).toFixed(1),
      AT:p.to>0?+(p.ast/p.to).toFixed(2):0, EFF:+(eff/g).toFixed(1), hasAdv:p.hasAdv
    };
  });

  gData = {};
  rows.forEach(r => {
    const nm = r[COL.nimi]; if(!nm) return;
    if(!gData[nm]) gData[nm]=[];
    gData[nm].push({g:r[COL.ottelu], pts:n(r[COL.pisteet]), opp:r[COL.vastustaja]});
  });
  Object.values(gData).forEach(a => a.sort((x,y) => x.g-y.g));
  players = Object.keys(pStats).sort();
}

function initApp(){
  seasons = [...new Set(allRows.map(r=>r[COL.kausi]).filter(Boolean))].sort().reverse();
  const sel = document.getElementById('seasonSel');
  seasons.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  curSeason = seasons[0];
  processSeason(curSeason);
  r1=players[0]; r2=players[1];
  tlSel = new Set(players.slice(0,3));
  updateRecord();
  buildRadarChips(); buildRadar();
  buildTlChips(); buildTimeline();
  buildTeamChart(); buildSG(); renderTable();
  const now = new Date();
  document.getElementById('upd').textContent = `P√§ivitetty ${now.toLocaleDateString('fi-FI')} klo ${now.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.display='block';
}

function changeSeason(){
  curSeason = document.getElementById('seasonSel').value;
  processSeason(curSeason);
  r1=players[0]; r2=players[1]; tlSel=new Set(players.slice(0,3));
  activePlayer=null; activeOpp=null;
  updateRecord(); buildRadarChips(); buildRadar();
  buildTlChips(); buildTimeline(); buildTeamChart(); buildSG(); renderBothTables();
}

function updateRecord(){
  const w=tGames.filter(g=>g[COL.tulos]==='Voitto').length;
  const l=tGames.filter(g=>g[COL.tulos]==='Tappio').length;
  document.getElementById('record').textContent=`${w}‚Äì${l}`;
}

const RK=['PPG','RPG','APG','SPG','BPG','FGp','AT'];
const RL=['Pisteet','Levypallot','Sy√∂t√∂t','Riistot','Blokit','FG%','AST/TO'];
function norm(k,v){ const mx=Math.max(...players.map(p=>pStats[p]?.[k]||0)); return mx>0?Math.round(v/mx*100):0; }

function buildRadarChips(){
  [['c1',0],['c2',1]].forEach(([id,idx]) => {
    const el=document.getElementById(id); el.innerHTML='';
    players.forEach((p,i) => {
      const cur=idx===0?r1:r2;
      const ch=document.createElement('button');
      ch.className='chip'+(p===cur?' on':'');
      if(p===cur) ch.style.background=PAL[i%PAL.length];
      ch.textContent=p;
      ch.onclick=()=>{ if(idx===0) r1=p; else r2=p; buildRadarChips(); buildRadar(); };
      el.appendChild(ch);
    });
  });
}

function buildRadar(){
  const ctx=document.getElementById('radarC').getContext('2d');
  const d1=pStats[r1]||{}, d2=pStats[r2]||{};
  if(rChart) rChart.destroy();
  rChart=new Chart(ctx,{type:'radar',data:{labels:RL,datasets:[
    {label:r1,data:RK.map(k=>norm(k,d1[k]||0)),borderColor:'#f0a500',backgroundColor:'rgba(240,165,0,.15)',pointBackgroundColor:'#f0a500',borderWidth:2},
    {label:r2,data:RK.map(k=>norm(k,d2[k]||0)),borderColor:'#5b8dee',backgroundColor:'rgba(91,141,238,.15)',pointBackgroundColor:'#5b8dee',borderWidth:2}
  ]},options:{responsive:true,
    scales:{r:{min:0,max:100,ticks:{display:false},grid:{color:'rgba(255,255,255,.08)'},pointLabels:{color:'#e8eaf0',font:{family:"'DM Sans'",size:12}},angleLines:{color:'rgba(255,255,255,.08)'}}},
    plugins:{legend:{labels:{color:'#e8eaf0',font:{family:"'DM Sans'",size:12}}}}}});
}

function buildTlChips(){
  const el=document.getElementById('tlChips'); el.innerHTML='';
  players.forEach((p,i) => {
    const ch=document.createElement('button');
    ch.className='chip'+(tlSel.has(p)?' on':'');
    if(tlSel.has(p)) ch.style.background=PAL[i%PAL.length];
    ch.textContent=p;
    ch.onclick=()=>{ tlSel.has(p)?tlSel.delete(p):tlSel.add(p); buildTlChips(); buildTimeline(); };
    el.appendChild(ch);
  });
}

function buildTimeline(){
  const ctx=document.getElementById('tlC').getContext('2d');
  const gns=tGames.map(g=>g[COL.ottelu]);
  const labels=tGames.map(g=>`O${g[COL.ottelu]} ${(g[COL.vastustaja]||'').split(' ')[0]}`);
  const datasets=[...tlSel].map(p => {
    const col=PAL[players.indexOf(p)%PAL.length];
    const perGame=gns.map(gn => { const e=(gData[p]||[]).find(d=>d.g===gn); return e?e.pts:null; });
    let data;
    if(tlMode==='kumu'){
      let sum=0;
      data=perGame.map(v => { if(v!==null) sum+=v; return v!==null?sum:null; });
    } else {
      data=perGame;
    }
    return{label:p,data,borderColor:col,backgroundColor:col+'33',pointBackgroundColor:col,tension:.3,spanGaps:true,borderWidth:2,pointRadius:5,pointHoverRadius:7};
  });

  // Joukkueen keskiarvo per ottelu
  if(tlMode==='peli'){
    const avgData=gns.map(gn=>{
      const gamePts=players.map(p=>{
        const e=(gData[p]||[]).find(d=>d.g===gn);
        return e?e.pts:null;
      }).filter(v=>v!==null);
      return gamePts.length>0 ? +(gamePts.reduce((a,b)=>a+b,0)/gamePts.length).toFixed(1) : null;
    });
    datasets.push({
      label:'Joukkueen ka.',
      data:avgData,
      borderColor:'rgba(255,255,255,0.4)',
      backgroundColor:'transparent',
      borderDash:[6,4],
      borderWidth:2,
      pointRadius:0,
      pointHoverRadius:4,
      tension:.3,
      spanGaps:true,
    });
  } else {
    // Kumulatiivisessa tilassa: kasvava keskiarvo
    let cumSum=0, cumCount=0;
    const avgData=gns.map(gn=>{
      const gamePts=players.map(p=>{
        const e=(gData[p]||[]).find(d=>d.g===gn);
        return e?e.pts:null;
      }).filter(v=>v!==null);
      if(gamePts.length>0){
        cumSum+=gamePts.reduce((a,b)=>a+b,0)/gamePts.length;
        cumCount++;
        return +cumSum.toFixed(1);
      }
      return null;
    });
    datasets.push({
      label:'Joukkueen ka.',
      data:avgData,
      borderColor:'rgba(255,255,255,0.4)',
      backgroundColor:'transparent',
      borderDash:[6,4],
      borderWidth:2,
      pointRadius:0,
      pointHoverRadius:4,
      tension:.3,
      spanGaps:true,
    });
  }

  if(tlChart) tlChart.destroy();
  tlChart=new Chart(ctx,{type:'line',data:{labels,datasets},options:{
    responsive:true, maintainAspectRatio:true,
    plugins:{legend:{labels:{color:'#e8eaf0',font:{family:"'DM Sans'",size:12},boxWidth:12,padding:16}},tooltip:{mode:'index',intersect:false}},
    scales:{
      x:{ticks:{color:'#7a8090',font:{size:11},maxRotation:45,minRotation:30},grid:{color:'rgba(255,255,255,.05)'}},
      y:{ticks:{color:'#7a8090'},grid:{color:'rgba(255,255,255,.05)'},title:{display:true,text:tlMode==='kumu'?'Pisteet yhteens√§':'Pisteet per peli',color:'#7a8090'}}
    }
  }});
}

function buildTeamChart(){
  const ctx=document.getElementById('teamC').getContext('2d');
  const labels=tGames.map(g=>`O${g[COL.ottelu]} ${(g[COL.vastustaja]||'').split(' ')[0]}`);
  const ppC=tGames.map(g=>g[COL.tulos]==='Voitto'?'#3ecf8e':'#e05a2b');
  const opC=tGames.map(g=>g[COL.tulos]==='Voitto'?'rgba(62,207,142,.3)':'rgba(224,90,43,.4)');
  if(tmChart) tmChart.destroy();
  tmChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[
    {label:'PP Pisteet',data:tGames.map(g=>n(g[COL.omaPts])),backgroundColor:ppC,borderRadius:4},
    {label:'Vastustaja',data:tGames.map(g=>n(g[COL.vastPts])),backgroundColor:opC,borderRadius:4}
  ]},options:{
    responsive:true, maintainAspectRatio:true,
    plugins:{legend:{labels:{color:'#e8eaf0',font:{family:"'DM Sans'"},boxWidth:12,padding:16}},
      tooltip:{callbacks:{title:ctx=>{ const g=tGames[ctx[0].dataIndex]; return `${g[COL.vastustaja]} (${g[COL.tulos]})`; }}}},
    scales:{
      x:{ticks:{color:'#7a8090',font:{size:11},maxRotation:45,minRotation:30},grid:{display:false}},
      y:{ticks:{color:'#7a8090'},grid:{color:'rgba(255,255,255,.05)'},min:0}
    }
  }});
}

function buildSG(){
  const el=document.getElementById('sg'); el.innerHTML='';
  const adv=players.filter(p=>pStats[p].hasAdv);
  if(!adv.length){ el.innerHTML='<p style="color:var(--muted);padding:20px">Ei edistyneit√§ tilastoja t√§ll√§ kaudella.</p>'; return; }
  adv.sort((a,b)=>(pStats[b].FGp||0)-(pStats[a].FGp||0)).forEach(p => {
    const d=pStats[p];
    el.innerHTML+=`<div class="sc"><div class="sc-name">${p}</div>
      <div style="display:flex;gap:12px;margin-bottom:14px">
        <div><div class="big">${d.PPG}</div><div class="biglbl">PPG</div></div>
        <div style="margin-left:auto;text-align:right"><div style="font-size:.75rem;color:var(--muted)">${d.Pelit} peli√§</div><div style="font-size:.75rem;color:var(--muted)">EFF ${d.EFF}</div></div>
      </div>
      <div class="bl"><span>FG%</span><span>${d.FGp}%</span></div><div class="bt"><div class="bf bfg" style="width:${d.FGp}%"></div></div>
      <div class="bl"><span>3PT%</span><span>${d.P3p}%</span></div><div class="bt"><div class="bf b3p" style="width:${d.P3p}%"></div></div>
      <div class="bl"><span>3PA/peli</span><span>${d.P3a}</span></div></div>`;
  });
}

// ‚îÄ‚îÄ TILASTOTAULUKKO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tblMode='yht';       // 'yht' | 'ppeli'
let activePlayer=null;   // valittu pelaaja
let activeOpp=null;      // valittu vastustaja
let sKeyP='pts', sDescP=true;
let sKeyO='label', sDescO=false;

function setTblMode(m){
  tblMode=m;
  const yht=m==='yht';
  document.getElementById('btnYht').style.cssText=`padding:7px 16px;border:none;background:${yht?'var(--accent)':'transparent'};color:${yht?'#0d0f14':'var(--muted)'};font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:${yht?'600':'500'};cursor:pointer`;
  document.getElementById('btnPPeli').style.cssText=`padding:7px 16px;border:none;background:${!yht?'var(--accent)':'transparent'};color:${!yht?'#0d0f14':'var(--muted)'};font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:${!yht?'600':'500'};cursor:pointer`;
  renderBothTables();
}

// Aggregoi rivit ryhmitt√§in
function parseMinutes(v){
  if(v==null||v===''||v===0) return null;
  if(typeof v==='number') return +(v*24*60).toFixed(1);
  if(typeof v==='string'){
    const s=v.trim();
    if(s==='') return null;
    // Apps Script palauttaa muodon "1899-12-29T22:43:29.000Z"
    // Otetaan vain aika-osa T:n j√§lkeen ja Z:n edest√§
    const isoMatch=s.match(/T(\d{2}):(\d{2}):(\d{2})/);
    if(isoMatch){
      const h=+isoMatch[1], m=+isoMatch[2], sec=+isoMatch[3];
      // UTC+2 offset (Helsinki) ‚Äî lis√§t√§√§n 2h
      const totalMin=h*60+m+sec/60+120;
      return +totalMin.toFixed(1);
    }
    // hh:mm:ss
    const parts=s.split(':');
    if(parts.length===3) return +(+parts[0]*60 + +parts[1] + +parts[2]/60).toFixed(1);
    if(parts.length===2) return +(+parts[0]*60 + +parts[1]).toFixed(1);
  }
  return null;
}

function aggregateRows(rows, groupKey){
  const map={};
  const oppGameNum={};
  const oppPtsMap={};   // vastustajan pisteet per ottelu
  const oppPlrMap={};   // pelaajam√§√§r√§ per ottelu
  rows.forEach(r=>{
    const k=r[groupKey]; if(!k) return;
    if(!map[k]) map[k]={label:k,gp:new Set(),pts:0,min:0,minHasData:false,fgm:0,fga:0,t3m:0,t3a:0,ftm:0,fta:0,orb:0,drb:0,rb:0,ast:0,stl:0,blk:0,to:0,pf:0,plrSet:new Set()};
    const m=map[k];
    m.gp.add(r[COL.ottelu]);
    m.pts+=n(r[COL.pisteet]);
    const mins=parseMinutes(r['Pl. Time']);
    if(mins!==null){ m.min+=mins; m.minHasData=true; }
    m.fgm+=n(r[COL.fgm]); m.fga+=n(r[COL.fga]);
    m.t3m+=n(r[COL.t3m]); m.t3a+=n(r[COL.t3a]);
    m.ftm+=n(r[COL.ftm]); m.fta+=n(r[COL.fta]);
    m.orb+=n(r[COL.orb]); m.drb+=n(r[COL.drb]); m.rb+=n(r[COL.rb]);
    m.ast+=n(r[COL.ast]); m.stl+=n(r[COL.stl]); m.blk+=n(r[COL.blk]);
    m.to+=n(r[COL.to]);   m.pf+=n(r[COL.pf]);
    // pelaajat per ottelu (vastustajataulua varten)
    if(r[COL.nimi]) m.plrSet.add(r[COL.nimi]);
    if(groupKey===COL.vastustaja){
      oppGameNum[k]=r[COL.ottelu];
      oppPtsMap[k]=n(r[COL.vastPts]);
    }
  });
  return Object.values(map).map(m=>{
    const g=m.gp.size;
    const div=tblMode==='ppeli'?g:1;
    const pct=(a,b)=>b>0?+(a/b*100).toFixed(1):'-';
    const v=x=>+(tblMode==='ppeli'?(x/div):(x)).toFixed(1);
    const gameNum=oppGameNum[m.label]||999;
    return{
      label:m.label,
      displayLabel:oppGameNum[m.label]!==undefined?`O${oppGameNum[m.label]} ${m.label}`:m.label,
      gameNum,
      gp:g,
      oppPts:oppPtsMap[m.label]||'-',
      plr:m.plrSet.size||'-',
      pts:v(m.pts), min:m.minHasData?v(m.min):'-',
      fgm:v(m.fgm), fga:v(m.fga), fgpct:pct(m.fgm,m.fga),
      t3m:v(m.t3m), t3a:v(m.t3a), t3pct:pct(m.t3m,m.t3a),
      ftm:v(m.ftm), fta:v(m.fta), ftpct:pct(m.ftm,m.fta),
      orb:v(m.orb), drb:v(m.drb), rb:v(m.rb),
      ast:v(m.ast), stl:v(m.stl), blk:v(m.blk), to:v(m.to), pf:v(m.pf),
    };
  });
}

const STAT_COLS_P=['pts','min','fgm','fga','fgpct','t3m','t3a','t3pct','ftm','fta','ftpct','orb','drb','rb','ast','stl','blk','to','pf'];
const STAT_COLS_O=['oppPts','plr','pts','min','fgm','fga','fgpct','t3m','t3a','t3pct','ftm','fta','ftpct','orb','drb','rb','ast','stl','blk','to','pf'];

function makeTotalRow(data, statCols){
  const total={label:'TOTAL',displayLabel:'TOTAL',gameNum:-1,gp:0,oppPts:0,plr:'-'};
  statCols.forEach(k=>total[k]=0);
  let hasMins=false, totalGP=0;
  data.forEach(r=>{
    totalGP+=r.gp||0;
    statCols.forEach(k=>{
      if(k==='fgpct'||k==='t3pct'||k==='ftpct') return; // lasketaan erikseen
      if(k==='plr'||k==='oppPts') return;
      if(r[k]!=='-'&&r[k]!=null) { total[k]=+(+total[k]+ +r[k]).toFixed(1); if(k==='min') hasMins=true; }
    });
    if(r.oppPts!=='-') total.oppPts=+(+total.oppPts + +r.oppPts).toFixed(0);
  });
  total.gp=totalGP;
  if(!hasMins) total.min='-';
  // Laske prosentit yhteistilastoista
  total.fgpct=total.fga>0?+(total.fgm/total.fga*100).toFixed(1):'-';
  total.t3pct=total.t3a>0?+(total.t3m/total.t3a*100).toFixed(1):'-';
  total.ftpct=total.fta>0?+(total.ftm/total.fta*100).toFixed(1):'-';
  if(tblMode==='ppeli'){
    // per peli -tilassa jaa pelim√§√§r√§ll√§
    const div=data.length>0?data[0].gp:1;
    statCols.forEach(k=>{
      if(k==='fgpct'||k==='t3pct'||k==='ftpct'||k==='plr') return;
      if(total[k]!=='-') total[k]=+(total[k]/data.length).toFixed(1);
    });
  }
  return total;
}

function sortAndRender(data, sKey, sDesc, tbodyId, clickFn, activeLabel, thPrefix, statCols){
  data.sort((a,b)=>{
    if(sKey==='label') return sDesc?b.gameNum-a.gameNum:a.gameNum-b.gameNum;
    if(sKey==='gp') return sDesc?b.gp-a.gp:a.gp-b.gp;
    const av=a[sKey]==='-'?-1:+(a[sKey]??0);
    const bv=b[sKey]==='-'?-1:+(b[sKey]??0);
    return sDesc?bv-av:av-bv;
  });
  const mx={};
  statCols.forEach(k=>{ const vals=data.map(r=>r[k]==='-'?0:+(r[k]||0)); mx[k]=Math.max(...vals); });

  const total=makeTotalRow(data, statCols);
  const totalHtml=`<tr class="total-row">
    <td>TOTAL</td><td>${total.gp}</td>
    ${statCols.map(k=>`<td>${total[k]!==undefined?total[k]:'-'}</td>`).join('')}
  </tr>`;

  document.getElementById(tbodyId).innerHTML = totalHtml + data.map(r=>`
    <tr onclick="${clickFn}('${r.label.replace(/'/g,"\\'")}',this)" style="cursor:pointer;${activeLabel===r.label?'background:rgba(240,165,0,.12);outline:1px solid var(--accent);':''}">
      <td style="white-space:nowrap">${r.displayLabel||r.label}</td>
      <td>${r.gp}</td>
      ${statCols.map(k=>`<td class="${r[k]!=='-'&&+(r[k]||0)===mx[k]&&mx[k]>0?'hl':''}">${r[k]}</td>`).join('')}
    </tr>`).join('');

  document.querySelectorAll(`#${thPrefix} th`).forEach(t=>t.classList.remove('sa','sd'));
  const keys=['label','gp',...statCols];
  const idx=keys.indexOf(sKey);
  const ths=document.querySelectorAll(`#${thPrefix} th`);
  if(idx>=0&&ths[idx]) ths[idx].classList.add(sDesc?'sd':'sa');
}

function getFilteredRows(){
  let rows=allRows.filter(r=>r[COL.kausi]===curSeason&&r[COL.sarja]==='Sarja');
  if(activeOpp)    rows=rows.filter(r=>r[COL.vastustaja]===activeOpp);
  if(activePlayer) rows=rows.filter(r=>r[COL.nimi]===activePlayer);
  return rows;
}

function renderBothTables(){
  const baseRows=allRows.filter(r=>r[COL.kausi]===curSeason&&r[COL.sarja]==='Sarja');

  const pRows=activeOpp?baseRows.filter(r=>r[COL.vastustaja]===activeOpp):baseRows;
  const pData=aggregateRows(pRows, COL.nimi);
  sortAndRender(pData,sKeyP,sDescP,'tbP','clickPlayer',activePlayer,'playerTable',STAT_COLS_P);

  const oRows=activePlayer?baseRows.filter(r=>r[COL.nimi]===activePlayer):baseRows;
  const oData=aggregateRows(oRows, COL.vastustaja);
  sortAndRender(oData,sKeyO,sDescO,'tbO','clickOpp',activeOpp,'oppTable',STAT_COLS_O);

  document.getElementById('p1label').innerHTML=`Pelaajat ${activeOpp?`<small style="color:var(--accent)">‚Äî ${activeOpp}</small>`:''}
    <span id="filterBadge" style="display:${activePlayer||activeOpp?'inline':'none'};background:var(--accent);color:#0d0f14;border-radius:4px;padding:2px 8px;font-size:.7rem;margin-left:8px;cursor:pointer" onclick="clearFilter()">‚úï Tyhjenn√§ suodatin</span>`;
  document.getElementById('p2label').innerHTML=`Vastustajat ${activePlayer?`<small style="color:var(--accent)">‚Äî ${activePlayer}</small>`:''}`;
}

function clickPlayer(name, tr){
  activePlayer = activePlayer===name ? null : name;
  activeOpp=null;
  renderBothTables();
}

function clickOpp(name, tr){
  activeOpp = activeOpp===name ? null : name;
  activePlayer=null;
  renderBothTables();
}

function clearFilter(){ activePlayer=null; activeOpp=null; renderBothTables(); }

function srtP(k){ if(sKeyP===k) sDescP=!sDescP; else{sKeyP=k;sDescP=true;} renderBothTables(); }
function srtO(k){ if(sKeyO===k) sDescO=!sDescO; else{sKeyO=k;sDescO=false;} renderBothTables(); }

function renderTable(){ renderBothTables(); }

function showTab(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

loadData();
</script>
</body>
</html>
